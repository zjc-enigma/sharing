<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Python web crawler</title>
<meta name="author" content="(jiancheng.zhai)"/>
<style type="text/css">
.underline { text-decoration: underline; }
</style>
<link rel="stylesheet" href="http://cdn.jsdelivr.net/reveal.js/3.0.0/css/reveal.css"/>

<link rel="stylesheet" href="http://cdn.jsdelivr.net/reveal.js/3.0.0/css/theme/night.css" id="theme"/>


<!-- If the query includes 'print-pdf', include the PDF print sheet -->
<script>
    if( window.location.search.match( /print-pdf/gi ) ) {
        var link = document.createElement( 'link' );
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = 'http://cdn.jsdelivr.net/reveal.js/3.0.0/css/print/pdf.css';
        document.getElementsByTagName( 'head' )[0].appendChild( link );
    }
</script>
</head>
<body>
<div class="reveal">
<div class="slides">
<section id="sec-title-slide"><h1 class="title">Python web crawler</h1><h2 class="author">jiancheng.zhai</h2><p class="date">Created: 2016-10-12 Wed 16:14</p>
</section>

<section>
<section id="slide-orgheadline1">
<h2 id="orgheadline1">流程</h2>

<div class="figure">
<p><img src="flow.png" alt="flow.png" width="110%" height="90%" />
</p>
</div>

</section>
</section>
<section>
<section id="slide-orgheadline5">
<h2 id="orgheadline5">请求</h2>
<div class="outline-text-2" id="text-orgheadline5">
</div></section>
<section id="slide-orgheadline2">
<h3 id="orgheadline2">urllib</h3>
<div class="org-src-container">

<pre  class="src src-python"><span style="color: #7590db;">values</span> = <span style="color: #4f97d7;">{}</span>
<span style="color: #7590db;">values</span><span style="color: #4f97d7;">[</span><span style="color: #2d9574;">'username'</span><span style="color: #4f97d7;">]</span> = <span style="color: #2d9574;">"1016903103@qq.com"</span>
<span style="color: #7590db;">values</span><span style="color: #4f97d7;">[</span><span style="color: #2d9574;">'password'</span><span style="color: #4f97d7;">]</span> = <span style="color: #2d9574;">"</span><span style="color: #cc9393;">XXXX</span><span style="color: #2d9574;">"</span>
<span style="color: #7590db;">headers</span> = <span style="color: #4f97d7;">{</span><span style="color: #2d9574;">'User-Agent'</span>:<span style="color: #2d9574;">'Mozilla/6.0 (Windows; U; Windows NT 6.1; en-US; rv:1.9.1.6) Gecko/20091201 Firefox/3.5.6'</span> <span style="color: #4f97d7;">}</span>
<span style="color: #7590db;">data</span> = urllib.urlencode<span style="color: #4f97d7;">(</span>values<span style="color: #4f97d7;">)</span> 
<span style="color: #7590db;">request</span> = urllib2.Request<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"http://www.baidu.com"</span>, data, headers=headers<span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">response</span> = urllib2.urlopen<span style="color: #4f97d7;">(</span>request<span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">print</span> response.read<span style="color: #4f97d7;">()</span>
</pre>
</div>

</section>
<section id="slide-orgheadline3">
<h3 id="orgheadline3">requests: HTTP for Humans 发送请求</h3>
<div class="org-src-container">

<pre  class="src src-python"><span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#35774;&#32622;&#32534;&#30721;</span>
r.encoding
<span style="color: #2d9574;">'utf-8'</span>
<span style="color: #7590db;">r.encoding</span> = <span style="color: #2d9574;">'ISO-8859-1'</span>

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#23450;&#21046; headers</span>
<span style="color: #7590db;">url</span> = <span style="color: #2d9574;">'https://api.github.com/some/endpoint'</span>
<span style="color: #7590db;">headers</span> = <span style="color: #4f97d7;">{</span><span style="color: #2d9574;">'user-agent'</span>: <span style="color: #2d9574;">'my-app/0.0.1'</span><span style="color: #4f97d7;">}</span>
<span style="color: #7590db;">r</span> = requests.get<span style="color: #4f97d7;">(</span>url, headers=headers<span style="color: #4f97d7;">)</span>

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#21457;&#36865;&#35831;&#27714;</span>
<span style="color: #7590db;">r</span> = requests.put<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"http://httpbin.org/put"</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">r</span> = requests.delete<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"http://httpbin.org/delete"</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">r</span> = requests.head<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"http://httpbin.org/get"</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">r</span> = requests.options<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"http://httpbin.org/get"</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

</section>
<section id="slide-orgheadline4">
<h3 id="orgheadline4">requests: HTTP for Humans 传递参数</h3>
<div class="org-src-container">

<pre  class="src src-python"><span style="color: #7590db;">payload</span> = <span style="color: #4f97d7;">{</span><span style="color: #2d9574;">'key1'</span>: <span style="color: #2d9574;">'value1'</span>, <span style="color: #2d9574;">'key2'</span>: <span style="color: #2d9574;">'value2'</span><span style="color: #4f97d7;">}</span>
<span style="color: #7590db;">r</span> = requests.get<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"http://httpbin.org/get"</span>, params=payload<span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>r.url<span style="color: #4f97d7;">)</span>
http://httpbin.org/get?<span style="color: #7590db;">key2</span>=value2&amp;<span style="color: #7590db;">key1</span>=value1
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#35835;&#21462;&#21709;&#24212;&#20869;&#23481;</span>
<span style="color: #7590db;">r</span> = requests.get<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'https://github.com/timeline.json'</span><span style="color: #4f97d7;">)</span>
r.text
u<span style="color: #2d9574;">'[{"repository":{"open_issues":0,"url":"https://github.com/...</span>
</pre>
</div>



</section>
</section>
<section>
<section id="slide-orgheadline10">
<h2 id="orgheadline10">解析</h2>
<div class="outline-text-2" id="text-orgheadline10">
</div></section>
<section id="slide-orgheadline6">
<h3 id="orgheadline6">html - beautifulsoup</h3>
<div class="org-src-container">

<pre  class="src src-python"><span style="color: #7590db;">html</span> = urllib2.urlopen<span style="color: #4f97d7;">(</span>req, timeout=<span style="color: #a45bad;">20</span><span style="color: #4f97d7;">)</span>.read<span style="color: #4f97d7;">()</span>
<span style="color: #7590db;">soup</span> = BeautifulSoup<span style="color: #4f97d7;">(</span>html, <span style="color: #2d9574;">"lxml"</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">title</span> = soup.title.get_text<span style="color: #4f97d7;">()</span>
<span style="color: #7590db;">tr_list</span> = soup.find_all<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'table'</span><span style="color: #4f97d7;">)[</span><span style="color: #a45bad;">0</span><span style="color: #4f97d7;">]</span>.find_all<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'tr'</span><span style="color: #4f97d7;">)</span>
</pre>
</div>
</section>
<section id="slide-orgheadline7">
<h3 id="orgheadline7">html - pyquery</h3>
<div class="org-src-container">

<pre  class="src src-python"><span style="color: #4f97d7; font-weight: bold;">from</span> pyquery <span style="color: #4f97d7; font-weight: bold;">import</span> PyQuery <span style="color: #4f97d7; font-weight: bold;">as</span> pq
<span style="color: #7590db;">doc</span> = pq<span style="color: #4f97d7;">(</span>requests.get<span style="color: #bc6ec5;">(</span>url, headers=headers<span style="color: #bc6ec5;">)</span>.text<span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">en_mean_list</span> = doc<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'div.trans-container'</span><span style="color: #4f97d7;">)(</span><span style="color: #2d9574;">'ul'</span><span style="color: #4f97d7;">)(</span><span style="color: #2d9574;">'p.wordGroup'</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<div class="figure">
<p><img src="a.png" alt="a.png" />
</p>
</div>

</section>
<section id="slide-orgheadline8">
<h3 id="orgheadline8">js - selenium</h3>
<div class="org-src-container">

<pre  class="src src-python"><span style="color: #4f97d7; font-weight: bold;">from</span> selenium <span style="color: #4f97d7; font-weight: bold;">import</span> webdriver
<span style="color: #4f97d7; font-weight: bold;">from</span> selenium.common.exceptions <span style="color: #4f97d7; font-weight: bold;">import</span> NoSuchElementException
<span style="color: #4f97d7; font-weight: bold;">from</span> selenium.webdriver.common.keys <span style="color: #4f97d7; font-weight: bold;">import</span> Keys
<span style="color: #7590db;">base_url</span> = <span style="color: #2d9574;">'http://www.baidu.com/'</span>
<span style="color: #7590db;">browser</span> = webdriver.Chrome<span style="color: #4f97d7;">()</span>
browser.get<span style="color: #4f97d7;">(</span>base_url<span style="color: #4f97d7;">)</span>

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#35835;&#21462;&#21709;&#24212;&#20869;&#23481;, &#36825;&#37324;&#20351;&#29992; pyquery &#36827;&#34892;&#35299;&#26512;</span>
<span style="color: #7590db;">doc</span> = pq<span style="color: #4f97d7;">(</span>browser.page_source<span style="color: #4f97d7;">)</span>
doc.xhtml_to_html<span style="color: #4f97d7;">()</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#28857;&#20987;&#20803;&#32032;</span>
browser.find_element_by_css_selector<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'.pagination .next'</span><span style="color: #4f97d7;">)</span>.click<span style="color: #4f97d7;">()</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#33719;&#21462; cookies</span>
<span style="color: #7590db;">cookies</span> = browser.get_cookies<span style="color: #4f97d7;">()</span>
</pre>
</div>

</section>
<section id="slide-orgheadline9">
<h3 id="orgheadline9">js - PhantomJS</h3>
<ul>
<li>HEADLESS WEBSITE TESTING</li>
<li>SCREEN CAPTURE</li>
<li>PAGE AUTOMATION</li>
<li>NETWORK MONITORING</li>
<li><a href="http://phantomjs.org/">http://phantomjs.org/</a></li>

</ul>


</section>
</section>
<section>
<section id="slide-orgheadline22">
<h2 id="orgheadline22">优化</h2>
<div class="outline-text-2" id="text-orgheadline22">
</div></section>
<section id="slide-orgheadline11">
<h3 id="orgheadline11">防屏蔽 - 代理池</h3>
<div class="org-src-container">

<pre  class="src src-python"><span style="color: #7590db;">page_num</span> = <span style="color: #a45bad;">10</span>
<span style="color: #7590db;">url_prefix</span> = <span style="color: #2d9574;">"http://www.xicidaili.com/wn/{pn}"</span>
<span style="color: #7590db;">url_list</span> = <span style="color: #4f97d7;">[</span>url_prefix.<span style="color: #4f97d7;">format</span><span style="color: #bc6ec5;">(</span>pn=x<span style="color: #bc6ec5;">)</span> <span style="color: #4f97d7; font-weight: bold;">for</span> x <span style="color: #4f97d7; font-weight: bold;">in</span> <span style="color: #4f97d7;">range</span><span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">1</span>, page_num<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">]</span>
<span style="color: #7590db;">headers</span> = <span style="color: #4f97d7;">{</span><span style="color: #2d9574;">'User-Agent'</span>:<span style="color: #2d9574;">'Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/33.0.1750.154 Safari/537.36'</span><span style="color: #4f97d7;">}</span>
<span style="color: #7590db;">headers</span><span style="color: #4f97d7;">[</span><span style="color: #2d9574;">'Content-Type'</span><span style="color: #4f97d7;">]</span> = <span style="color: #2d9574;">'application/x-www-form-urlencoded'</span>
<span style="color: #7590db;">requests</span> = requests.get<span style="color: #4f97d7;">(</span>url, headers=headers<span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">soup</span> = BeautifulSoup<span style="color: #4f97d7;">(</span>requests.text<span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">tables</span> = soup.findAll<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'table'</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">trs</span> = table.findAll<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'tr'</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">res_list</span> = <span style="color: #4f97d7;">[]</span>
<span style="color: #4f97d7; font-weight: bold;">for</span> index, tr <span style="color: #4f97d7; font-weight: bold;">in</span> <span style="color: #4f97d7;">enumerate</span><span style="color: #4f97d7;">(</span>trs<span style="color: #4f97d7;">)</span>:
<span style="background-color: #555;"> </span>   res_list.append<span style="color: #4f97d7;">(</span>item.text.encode<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">'utf8'</span><span style="color: #bc6ec5;">)</span>.strip<span style="color: #bc6ec5;">()</span><span style="color: #4f97d7;">)</span>

<span style="color: #7590db;">ip</span>, <span style="color: #7590db;">port</span>, <span style="color: #7590db;">country</span>, <span style="color: #7590db;">proxy_type</span>, <span style="color: #7590db;">protocol</span> = res_list<span style="color: #4f97d7;">[</span><span style="color: #a45bad;">1</span>:<span style="color: #a45bad;">6</span><span style="color: #4f97d7;">]</span>
</pre>
</div>
<p>
其他: TOR / ADSL
</p>
</section>
<section id="slide-orgheadline12">
<h3 id="orgheadline12">防屏蔽 - headers</h3>

<div class="figure">
<p><img src="good_header.jpg" alt="good_header.jpg" width="50%" height="50%" />
</p>
</div>

<div class="figure">
<p><img src="bad_header.png" alt="bad_header.png" width="50%" height="50%" />
</p>
</div>

</section>
<section id="slide-orgheadline13">
<h3 id="orgheadline13">防屏蔽 - fake headers</h3>
<div class="org-src-container">

<pre  class="src src-python"><span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#38543;&#26426;&#25442; user agent</span>
<span style="color: #4f97d7; font-weight: bold;">from</span> fake_useragent <span style="color: #4f97d7; font-weight: bold;">import</span> UserAgent
<span style="color: #7590db;">ua</span> = UserAgent<span style="color: #4f97d7;">()</span>
<span style="color: #7590db;">headers</span> = <span style="color: #4f97d7;">{</span><span style="color: #2d9574;">'User-Agent'</span>: ua.random<span style="color: #4f97d7;">}</span>
</pre>
</div>
</section>
<section id="slide-orgheadline14">
<h3 id="orgheadline14">防屏蔽 - 合理的抓取频率</h3>
<p>
time.sleep(5 + random.randint(1,3))
</p>
</section>
<section id="slide-orgheadline15">
<h3 id="orgheadline15">DNS Server</h3>
</section>
<section id="slide-orgheadline16">
<h3 id="orgheadline16">cookie</h3>
<div class="org-src-container">

<pre  class="src src-python"><span style="color: #4f97d7; font-weight: bold;">import</span> browsercookie
<span style="color: #7590db;">cj</span> = browsercookie.chrome<span style="color: #4f97d7;">()</span>
<span style="color: #7590db;">opener</span> = urllib2.build_opener<span style="color: #4f97d7;">(</span>urllib2.HTTPCookieProcessor<span style="color: #bc6ec5;">(</span>cj<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">response</span> = opener.<span style="color: #4f97d7;">open</span><span style="color: #4f97d7;">(</span>url<span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">html</span> = response.read<span style="color: #4f97d7;">()</span>
</pre>
</div>
<p>
chrome 插件 EditThisCookie <a href="http://www.editthiscookie.com/">http://www.editthiscookie.com/</a>
</p>
</section>
<section id="slide-orgheadline17">
<h3 id="orgheadline17">bloom filter</h3>
<div class="org-src-container">

<pre  class="src src-python"><span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#22823;&#26679;&#26412;&#19979; Hash &#31354;&#38388;/&#26102;&#38388;&#28040;&#32791;&#22343;&#19981;&#29702;&#24819;</span>
<span style="color: #4f97d7; font-weight: bold;">from</span> pybloom <span style="color: #4f97d7; font-weight: bold;">import</span> BloomFilter, ScalableBloomFilter
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#35823;&#25253;&#29575; 0.1%</span>
<span style="color: #7590db;">bf</span> = BloomFilter<span style="color: #4f97d7;">(</span>capacity=<span style="color: #a45bad;">10000</span>, error_rate=<span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">001</span><span style="color: #4f97d7;">)</span>
bf.add<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'test'</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">print</span> <span style="color: #2d9574;">'test'</span> <span style="color: #4f97d7; font-weight: bold;">in</span> bf
<span style="color: #7590db;">sbf</span> = ScalableBloomFilter<span style="color: #4f97d7;">(</span>mode=ScalableBloomFilter.SMALL_SET_GROWTH<span style="color: #4f97d7;">)</span>
sbf.add<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'dddd'</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">print</span> <span style="color: #2d9574;">'ddd'</span> <span style="color: #4f97d7; font-weight: bold;">in</span> sbf
</pre>
</div>
</section>
<section id="slide-orgheadline18">
<h3 id="orgheadline18">并发 - 进程池</h3>
<div class="org-src-container">

<pre  class="src src-python"><span style="color: #4f97d7; font-weight: bold;">from</span> multiprocessing <span style="color: #4f97d7; font-weight: bold;">import</span> Process, Event
<span style="color: #4f97d7; font-weight: bold;">from</span> multiprocessing <span style="color: #4f97d7; font-weight: bold;">import</span> Manager
<span style="color: #4f97d7; font-weight: bold;">from</span> multiprocessing <span style="color: #4f97d7; font-weight: bold;">import</span> Queue, JoinableQueue
<span style="color: #7590db;">POISON_PILL</span> = <span style="color: #2d9574;">"POISON_END_PROCESSING"</span>
<span style="color: #7590db;">manager</span> = Manager<span style="color: #4f97d7;">()</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#22810;&#36827;&#31243;&#20849;&#20139;&#38431;&#21015;</span>
<span style="color: #7590db;">working_queue</span> = manager.Queue<span style="color: #4f97d7;">()</span>
<span style="color: #7590db;">output_queue</span> = manager.Queue<span style="color: #4f97d7;">()</span>
<span style="color: #7590db;">WORKER_NUM</span> = <span style="color: #a45bad;">20</span>

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#21551;&#21160;&#20889;&#32447;&#31243;</span>
<span style="color: #7590db;">writer_proc</span> = Process<span style="color: #4f97d7;">(</span>target=write_to_disk, args=<span style="color: #bc6ec5;">(</span>output_queue, <span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
writer_proc.start<span style="color: #4f97d7;">()</span>

<span style="color: #7590db;">pool</span> = Pool<span style="color: #4f97d7;">(</span>processes=WORKER_NUM<span style="color: #4f97d7;">)</span>
pool.<span style="color: #4f97d7;">apply</span><span style="color: #4f97d7;">(</span>crawl_url, <span style="color: #bc6ec5;">(</span>working_queue, output_queue<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="color: #2aa1ae; background-color: #292e34;">#</span><span style="color: #2aa1ae; background-color: #292e34;">pool.apply_async(crawl_url, (working_queue, output_queue))</span>
pool.close<span style="color: #4f97d7;">()</span>
pool.join<span style="color: #4f97d7;">()</span>
</pre>
</div>

</section>
<section id="slide-orgheadline19">
<h3 id="orgheadline19">并发 - 协程</h3>
<div class="org-src-container">

<pre  class="src src-python"><span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">crawl_url</span><span style="color: #4f97d7;">()</span>:
<span style="background-color: #555;"> </span>   <span style="color: #7590db;">send_headers</span> = <span style="color: #4f97d7;">{</span><span style="color: #2d9574;">'User-Agent'</span>: <span style="color: #2d9574;">'Mozilla/6.0 (Windows; U; Windows NT 6.1; en-US; rv:1.9.1.6) Gecko/20091201 Firefox/3.5.6'</span><span style="color: #4f97d7;">}</span>
<span style="background-color: #555;"> </span>   <span style="color: #7590db;">crawl_res</span> = <span style="color: #4f97d7;">{}</span>
<span style="background-color: #555;"> </span>   <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #a45bad;">True</span>:
<span style="background-color: #555;"> </span>   <span style="background-color: #555;"> </span>   <span style="color: #7590db;">url</span> = <span style="color: #4f97d7; font-weight: bold;">yield</span> crawl_res
<span style="background-color: #555;"> </span>   <span style="background-color: #555;"> </span>   <span style="color: #7590db;">request</span> = urllib2.Request<span style="color: #4f97d7;">(</span>url, headers=headers<span style="color: #4f97d7;">)</span>
<span style="background-color: #555;"> </span>   <span style="background-color: #555;"> </span>   <span style="color: #7590db;">html</span> = urllib2.urlopen<span style="color: #4f97d7;">(</span>req, timeout=<span style="color: #a45bad;">10</span><span style="color: #4f97d7;">)</span>.read<span style="color: #4f97d7;">()</span>
<span style="background-color: #555;"> </span>   <span style="background-color: #555;"> </span>   <span style="color: #7590db;">title</span> = BeautifulSoup<span style="color: #4f97d7;">(</span>html, <span style="color: #2d9574;">"lxml"</span><span style="color: #4f97d7;">)</span>.title.get_text<span style="color: #4f97d7;">()</span>
<span style="background-color: #555;"> </span>   <span style="background-color: #555;"> </span>   <span style="color: #7590db;">crawl_res</span><span style="color: #4f97d7;">[</span>url<span style="color: #4f97d7;">]</span> = title

<span style="color: #7590db;">crawler</span> = crawl_url
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#35201;&#20808;&#25191;&#34892;&#19968;&#27425; next &#26041;&#27861;</span>
<span style="color: #7590db;">crawl_res</span> = crawler.<span style="color: #4f97d7;">next</span><span style="color: #4f97d7;">()</span>

<span style="color: #7590db;">result_list</span> = <span style="color: #4f97d7;">[]</span>
<span style="color: #4f97d7; font-weight: bold;">for</span> url <span style="color: #4f97d7; font-weight: bold;">in</span> url_list:
<span style="background-color: #555;"> </span>   <span style="color: #7590db;">crawl_res</span> = crawler.send<span style="color: #4f97d7;">(</span>url<span style="color: #4f97d7;">)</span>
<span style="background-color: #555;"> </span>   result_list.append<span style="color: #4f97d7;">(</span>crawl_res<span style="color: #4f97d7;">)</span>
</pre>
</div>

</section>
<section id="slide-orgheadline20">
<h3 id="orgheadline20">并发 - 多进程 + 协程</h3>
<div class="org-src-container">

<pre  class="src src-python"><span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">multiprocessing &#30340; pool &#21644; gevent &#20914;&#31361;</span>
<span style="color: #4f97d7; font-weight: bold;">from</span> multiprocessing <span style="color: #4f97d7; font-weight: bold;">import</span> Process
<span style="color: #4f97d7; font-weight: bold;">import</span> gevent
<span style="color: #4f97d7; font-weight: bold;">from</span> gevent <span style="color: #4f97d7; font-weight: bold;">import</span> monkey; monkey.patch_all<span style="color: #4f97d7;">()</span>

<span style="color: #2aa1ae; background-color: #292e34;">#</span><span style="color: #2aa1ae; background-color: #292e34;">&#20351;&#29992;&#21327;&#31243;&#26469;&#25191;&#34892;</span>
<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">process_start</span><span style="color: #4f97d7;">(</span>tasks<span style="color: #4f97d7;">)</span>:
<span style="background-color: #555;"> </span>   gevent.joinall<span style="color: #4f97d7;">(</span>tasks<span style="color: #4f97d7;">)</span>


<span style="color: #4f97d7; font-weight: bold;">with</span> <span style="color: #4f97d7;">open</span><span style="color: #4f97d7;">(</span>crawl_url_file<span style="color: #4f97d7;">)</span> <span style="color: #4f97d7; font-weight: bold;">as</span> url_reader:
<span style="background-color: #555;"> </span>   <span style="color: #7590db;">url</span> = url_reader.readline.strip<span style="color: #4f97d7;">()</span>
<span style="background-color: #555;"> </span>   <span style="color: #7590db;">task_list</span> = <span style="color: #4f97d7;">[]</span>
<span style="background-color: #555;"> </span>   <span style="color: #7590db;">i</span> = <span style="color: #a45bad;">0</span>
<span style="background-color: #555;"> </span>   <span style="color: #4f97d7; font-weight: bold;">while</span> url:
<span style="background-color: #555;"> </span>   <span style="background-color: #555;"> </span>   <span style="color: #7590db;">i</span> += <span style="color: #a45bad;">1</span>
<span style="background-color: #555;"> </span>   <span style="background-color: #555;"> </span>   task_list.append<span style="color: #4f97d7;">(</span>gevent.spawn<span style="color: #bc6ec5;">(</span>crawl_method, url, <span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

<span style="background-color: #555;"> </span>   <span style="background-color: #555;"> </span>   <span style="color: #4f97d7; font-weight: bold;">if</span> i &gt;= MAX_TASK_NUM:
<span style="background-color: #555;"> </span>   <span style="background-color: #555;"> </span>   <span style="background-color: #555;"> </span>   <span style="color: #7590db;">p</span> = Process<span style="color: #4f97d7;">(</span>target=process_start, args=<span style="color: #bc6ec5;">(</span>task_list, <span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="background-color: #555;"> </span>   <span style="background-color: #555;"> </span>   <span style="background-color: #555;"> </span>   p.start<span style="color: #4f97d7;">()</span>
<span style="background-color: #555;"> </span>   <span style="background-color: #555;"> </span>   <span style="background-color: #555;"> </span>   <span style="color: #7590db;">task_list</span> = <span style="color: #4f97d7;">[]</span>
<span style="background-color: #555;"> </span>   <span style="background-color: #555;"> </span>   <span style="background-color: #555;"> </span>   <span style="color: #7590db;">i</span> = <span style="color: #a45bad;">0</span>
<span style="background-color: #555;"> </span>   <span style="background-color: #555;"> </span>   <span style="color: #7590db;">url</span> = url_reader.readline.strip<span style="color: #4f97d7;">()</span>

<span style="background-color: #555;"> </span>   <span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#25235;&#21462;&#21097;&#20313; url</span>
<span style="background-color: #555;"> </span>   <span style="color: #4f97d7; font-weight: bold;">if</span> task_list:
<span style="background-color: #555;"> </span>   <span style="background-color: #555;"> </span>   <span style="color: #7590db;">p</span> = Process<span style="color: #4f97d7;">(</span>target=process_start, args=<span style="color: #bc6ec5;">(</span>task_list, <span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="background-color: #555;"> </span>   <span style="background-color: #555;"> </span>   p.start<span style="color: #4f97d7;">()</span>
</pre>
</div>

</section>
<section id="slide-orgheadline21">
<h3 id="orgheadline21">并发 - 分布式</h3>
<div class="org-src-container">

<pre  class="src src-python"><span style="color: #4f97d7; font-weight: bold;">import</span> redis
<span style="color: #7590db;">redis_conn</span> = redis.StrictRedis<span style="color: #4f97d7;">(</span>host=<span style="color: #2d9574;">'192.168.1.108'</span>, port=<span style="color: #a45bad;">6379</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">WORKING_QUEUE</span> = <span style="color: #2d9574;">'WORKING'</span>
<span style="color: #7590db;">OUTPUT_QUEUE</span> = <span style="color: #2d9574;">'OUTPUT'</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">writer &#36827;&#31243;</span>
<span style="color: #7590db;">writer</span> = Process<span style="color: #4f97d7;">(</span>target=write_to_disk, args=<span style="color: #bc6ec5;">(</span>redis_conn, OUTPUT_QUEUE<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
writer.start<span style="color: #4f97d7;">()</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">worker &#36827;&#31243;</span>
<span style="color: #7590db;">task_list</span> = <span style="color: #4f97d7;">[]</span>
<span style="color: #7590db;">i</span> = <span style="color: #a45bad;">0</span>
<span style="color: #4f97d7; font-weight: bold;">while</span> redis_conn.llen<span style="color: #4f97d7;">(</span>WORKING_QUEUE<span style="color: #4f97d7;">)</span> &gt; <span style="color: #a45bad;">0</span>:
<span style="background-color: #555;"> </span>   <span style="color: #7590db;">i</span> += <span style="color: #a45bad;">1</span>
<span style="background-color: #555;"> </span>   task_list.append<span style="color: #4f97d7;">(</span>redis_conn.lpop<span style="color: #bc6ec5;">(</span>WORKING_QUEUE<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

<span style="background-color: #555;"> </span>   <span style="color: #4f97d7; font-weight: bold;">if</span> i &gt;= MAX_TASK_NUM:
<span style="background-color: #555;"> </span>   <span style="background-color: #555;"> </span>   <span style="color: #7590db;">p</span> = Process<span style="color: #4f97d7;">(</span>target=crawl_url, args=<span style="color: #bc6ec5;">(</span>task_list, OUTPUT_QUEUE<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="background-color: #555;"> </span>   <span style="background-color: #555;"> </span>   p.start<span style="color: #4f97d7;">()</span>
<span style="background-color: #555;"> </span>   <span style="background-color: #555;"> </span>   <span style="color: #7590db;">task_list</span> = <span style="color: #4f97d7;">[]</span>
<span style="background-color: #555;"> </span>   <span style="background-color: #555;"> </span>   <span style="color: #7590db;">i</span> = <span style="color: #a45bad;">0</span>

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#25235;&#21462;&#21097;&#20313; url</span>
<span style="color: #4f97d7; font-weight: bold;">if</span> task_list:
<span style="background-color: #555;"> </span>   <span style="color: #7590db;">p</span> = Process<span style="color: #4f97d7;">(</span>target=crawl_url, args=<span style="color: #bc6ec5;">(</span>task_list, OUTPUT_QUEUE<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="background-color: #555;"> </span>   p.start<span style="color: #4f97d7;">()</span>
</pre>
</div>


</section>
</section>
<section>
<section id="slide-orgheadline26">
<h2 id="orgheadline26">存储</h2>
<div class="outline-text-2" id="text-orgheadline26">
</div></section>
<section id="slide-orgheadline23">
<h3 id="orgheadline23">sqllite</h3>
<div class="org-src-container">

<pre  class="src src-python"><span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#36731;&#37327;&#32423;</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#36328;&#24179;&#21488;</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#35835;&#20889;&#36895;&#24230;&#24555;</span>
<span style="color: #4f97d7; font-weight: bold;">from</span> sqlalchemy <span style="color: #4f97d7; font-weight: bold;">import</span> create_engine
<span style="color: #4f97d7; font-weight: bold;">from</span> sqlalchemy.orm <span style="color: #4f97d7; font-weight: bold;">import</span> sessionmaker, mapper
<span style="color: #4f97d7; font-weight: bold;">from</span> sqlalchemy <span style="color: #4f97d7; font-weight: bold;">import</span> Column, Integer, String, FLOAT, DATE
<span style="color: #4f97d7; font-weight: bold;">from</span> sqlalchemy.ext.declarative <span style="color: #4f97d7; font-weight: bold;">import</span> declarative_base
<span style="color: #7590db;">engine</span> = create_engine<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'sqlite:///proxy.db'</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">Base</span> = declarative_base<span style="color: #4f97d7;">()</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#23450;&#20041;&#25968;&#25454; model</span>
<span style="color: #4f97d7; font-weight: bold;">class</span> <span style="color: #ce537a; font-weight: bold;">Proxy</span><span style="color: #4f97d7;">(</span>Base<span style="color: #4f97d7;">)</span>:
<span style="background-color: #555;"> </span>   <span style="color: #7590db;">__tablename__</span> = <span style="color: #2d9574;">'proxy'</span>

<span style="background-color: #555;"> </span>   <span style="color: #4f97d7;">id</span> = Column<span style="color: #4f97d7;">(</span>Integer, primary_key=<span style="color: #a45bad;">True</span><span style="color: #4f97d7;">)</span>
<span style="background-color: #555;"> </span>   <span style="color: #7590db;">ip</span> = Column<span style="color: #4f97d7;">(</span>String<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">100</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="background-color: #555;"> </span>   <span style="color: #7590db;">port</span> = Column<span style="color: #4f97d7;">(</span>String<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">100</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="background-color: #555;"> </span>   <span style="color: #7590db;">country</span> = Column<span style="color: #4f97d7;">(</span>String<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">100</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="background-color: #555;"> </span>   <span style="color: #7590db;">proxy_type</span> = Column<span style="color: #4f97d7;">(</span>String<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">100</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="background-color: #555;"> </span>   <span style="color: #7590db;">protocol</span> = Column<span style="color: #4f97d7;">(</span>String<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">100</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="background-color: #555;"> </span>   <span style="color: #7590db;">delay</span> = Column<span style="color: #4f97d7;">(</span>FLOAT<span style="color: #4f97d7;">)</span>
<span style="background-color: #555;"> </span>   <span style="color: #7590db;">date</span> = Column<span style="color: #4f97d7;">(</span>DATE<span style="color: #4f97d7;">)</span>

Base.metadata.create_all<span style="color: #4f97d7;">(</span>engine<span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">DBSession</span> = sessionmaker<span style="color: #4f97d7;">(</span>bind=engine<span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">session</span> = DBSession<span style="color: #4f97d7;">()</span>
<span style="color: #7590db;">proxy_list</span> = session.query<span style="color: #4f97d7;">(</span>Proxy<span style="color: #4f97d7;">)</span>.<span style="color: #4f97d7;">all</span><span style="color: #4f97d7;">()</span>
session.close<span style="color: #4f97d7;">()</span>
</pre>
</div>

</section>
<section id="slide-orgheadline24">
<h3 id="orgheadline24">mongodb</h3>
<div class="org-src-container">

<pre  class="src src-python"><span style="color: #4f97d7; font-weight: bold;">from</span> pymongo <span style="color: #4f97d7; font-weight: bold;">import</span> MongoClient
<span style="color: #7590db;">client</span> = MongoClient<span style="color: #4f97d7;">()</span>
<span style="color: #7590db;">db</span> = client.proxy_db
<span style="color: #7590db;">proxy</span> = db.get_collection<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"proxy"</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">proxy_item</span> = <span style="color: #4f97d7;">{</span><span style="color: #2d9574;">"ip"</span>: <span style="color: #a45bad;">127</span>.<span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">1</span>, <span style="color: #2d9574;">"port"</span>: <span style="color: #a45bad;">1080</span><span style="color: #4f97d7;">}</span>
proxy.insert<span style="color: #4f97d7;">(</span>proxy_item<span style="color: #4f97d7;">)</span>
</pre>
</div>
</section>
<section id="slide-orgheadline25">
<h3 id="orgheadline25">postgreSQL</h3>
<div class="org-src-container">

<pre  class="src src-python"><span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">JSONB &#31867;&#22411;&#23436;&#20840;&#25903;&#25345;&#32034;&#24341;</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#22823;&#25968;&#25454;&#37327;&#22330;&#26223;&#36895;&#24230;&#24555;,&#24615;&#33021;&#26354;&#32447;&#24179;&#31283;</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#25554;&#20837;&#26597;&#35810;&#25805;&#20316;&#25928;&#29575;&#39640;</span>

<span style="color: #7590db;">SQLALCHEMY_DATABASE_URI</span> = <span style="color: #2d9574;">"postgresql://Patrick:123456@localhost/youdao"</span>
<span style="color: #4f97d7; font-weight: bold;">from</span> sqlalchemy.dialects.postgresql <span style="color: #4f97d7; font-weight: bold;">import</span> JSONB

<span style="color: #4f97d7; font-weight: bold;">class</span> <span style="color: #ce537a; font-weight: bold;">YoudaoDict</span><span style="color: #4f97d7;">(</span>db.Model<span style="color: #4f97d7;">)</span>:

<span style="background-color: #555;"> </span>   <span style="color: #7590db;">__tablename__</span> = <span style="color: #2d9574;">'youdao_dict'</span>

<span style="background-color: #555;"> </span>   <span style="color: #4f97d7;">id</span> = db.Column<span style="color: #4f97d7;">(</span>db.Integer, primary_key=<span style="color: #a45bad;">True</span><span style="color: #4f97d7;">)</span>
<span style="background-color: #555;"> </span>   <span style="color: #7590db;">char</span> = db.Column<span style="color: #4f97d7;">(</span>db.String<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">20</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="background-color: #555;"> </span>   <span style="color: #7590db;">char_unicode</span> = db.Column<span style="color: #4f97d7;">(</span>db.String<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">20</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="background-color: #555;"> </span>   <span style="color: #7590db;">content</span> = db.Column<span style="color: #4f97d7;">(</span>JSONB<span style="color: #4f97d7;">)</span>

<span style="background-color: #555;"> </span>   <span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">__repr__</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">self</span><span style="color: #4f97d7;">)</span>:
<span style="background-color: #555;"> </span>   <span style="background-color: #555;"> </span>   <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"&lt;char : %s&gt;"</span> % <span style="color: #4f97d7; font-weight: bold;">self</span>.char<span style="color: #4f97d7;">)</span>

<span style="color: #7590db;">res_list</span> = YoudaoDict.query.<span style="color: #4f97d7;">filter</span><span style="color: #4f97d7;">(</span>
YoudaoDict.content<span style="color: #bc6ec5;">[</span><span style="color: #2d9574;">'detail_mean'</span><span style="color: #bc6ec5;">]</span>.astext.like<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"%"</span>+query+<span style="color: #2d9574;">"%"</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>.<span style="color: #4f97d7;">all</span><span style="color: #4f97d7;">()[</span>:<span style="color: #a45bad;">10</span><span style="color: #4f97d7;">]</span>
</pre>
</div>


</section>
</section>
<section>
<section id="slide-orgheadline33">
<h2 id="orgheadline33">框架</h2>
<div class="outline-text-2" id="text-orgheadline33">
</div></section>
<section id="slide-orgheadline27">
<h3 id="orgheadline27">scrapy - architecture</h3>

<div class="figure">
<p><img src="scrapy.png" alt="scrapy.png" />
</p>
</div>

</section>
<section id="slide-orgheadline28">
<h3 id="orgheadline28">scrapy - tree</h3>

<div class="figure">
<p><img src="c.png" alt="c.png" width="45%" height="45%" />
</p>
</div>

</section>
<section id="slide-orgheadline29">
<h3 id="orgheadline29">scrapy - items.py</h3>
<div class="org-src-container">

<pre  class="src src-python"><span style="color: #4f97d7; font-weight: bold;">import</span> scrapy

<span style="color: #4f97d7; font-weight: bold;">class</span> <span style="color: #ce537a; font-weight: bold;">DomainItem</span><span style="color: #4f97d7;">(</span>scrapy.Item<span style="color: #4f97d7;">)</span>:
<span style="background-color: #555;"> </span>   <span style="color: #7590db;">domain</span> = scrapy.Field<span style="color: #4f97d7;">()</span>
<span style="background-color: #555;"> </span>   <span style="color: #7590db;">title</span> = scrapy.Field<span style="color: #4f97d7;">()</span>
<span style="background-color: #555;"> </span>   <span style="color: #7590db;">keywords</span> = scrapy.Field<span style="color: #4f97d7;">()</span>
<span style="background-color: #555;"> </span>   <span style="color: #7590db;">desc</span> = scrapy.Field<span style="color: #4f97d7;">()</span>
</pre>
</div>

</section>
<section id="slide-orgheadline30">
<h3 id="orgheadline30">scrapy - spider.py</h3>
<div class="org-src-container">

<pre  class="src src-python"><span style="color: #4f97d7; font-weight: bold;">from</span> scrapy.spider <span style="color: #4f97d7; font-weight: bold;">import</span> BaseSpider
<span style="color: #4f97d7; font-weight: bold;">from</span> domain_parse.items <span style="color: #4f97d7; font-weight: bold;">import</span> DomainItem

<span style="color: #4f97d7; font-weight: bold;">class</span> <span style="color: #ce537a; font-weight: bold;">DomainSpider</span><span style="color: #4f97d7;">(</span>BaseSpider<span style="color: #4f97d7;">)</span>:
<span style="background-color: #555;"> </span>   <span style="color: #7590db;">name</span> = <span style="color: #2d9574;">'domain'</span>
<span style="background-color: #555;"> </span>   <span style="color: #7590db;">domain_list</span> = <span style="color: #4f97d7;">open</span><span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'domain_list'</span><span style="color: #4f97d7;">)</span>
<span style="background-color: #555;"> </span>   <span style="color: #7590db;">start_urls</span> = <span style="color: #4f97d7;">[</span> domain.strip<span style="color: #bc6ec5;">()</span> <span style="color: #4f97d7; font-weight: bold;">for</span> domain <span style="color: #4f97d7; font-weight: bold;">in</span> domain_list.readlines<span style="color: #bc6ec5;">()</span> <span style="color: #4f97d7;">]</span>
<span style="background-color: #555;"> </span>   domain_list.close<span style="color: #4f97d7;">()</span>

<span style="background-color: #555;"> </span>   <span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">parse</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">self</span>, response<span style="color: #4f97d7;">)</span>:
<span style="background-color: #555;"> </span>   <span style="background-color: #555;"> </span>   <span style="color: #7590db;">domain</span> = response.url
<span style="background-color: #555;"> </span>   <span style="background-color: #555;"> </span>   <span style="color: #7590db;">title</span> = response.selector.xpath<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"//title/text()"</span><span style="color: #4f97d7;">)</span>.extract_first<span style="color: #4f97d7;">()</span>
<span style="background-color: #555;"> </span>   <span style="background-color: #555;"> </span>   <span style="color: #7590db;">keywords</span> = response.selector.xpath<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"//meta[@name='keywords']/@content"</span><span style="color: #4f97d7;">)</span>.extract_first<span style="color: #4f97d7;">()</span>
<span style="background-color: #555;"> </span>   <span style="background-color: #555;"> </span>   <span style="color: #7590db;">desc</span> = response.selector.xpath<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"//meta[@name='description']/@content"</span><span style="color: #4f97d7;">)</span>.extract_first<span style="color: #4f97d7;">()</span>
<span style="background-color: #555;"> </span>   <span style="background-color: #555;"> </span>   <span style="color: #4f97d7; font-weight: bold;">yield</span> DomainItem<span style="color: #4f97d7;">(</span>domain=domain, title=title, keywords=keywords, desc=desc<span style="color: #4f97d7;">)</span>
</pre>
</div>

</section>
<section id="slide-orgheadline31">
<h3 id="orgheadline31">scrapy - settings.py</h3>
<div class="org-src-container">

<pre  class="src src-python"><span style="color: #7590db;">BOT_NAME</span> = <span style="color: #2d9574;">'domain_parse'</span>
<span style="color: #7590db;">SPIDER_MODULES</span> = <span style="color: #4f97d7;">[</span><span style="color: #2d9574;">'domain_parse.spiders'</span><span style="color: #4f97d7;">]</span>
<span style="color: #7590db;">NEWSPIDER_MODULE</span> = <span style="color: #2d9574;">'domain_parse.spiders'</span>
<span style="color: #7590db;">RETRY_TIMES</span> = <span style="color: #a45bad;">10</span>
<span style="color: #7590db;">RETRY_HTTP_CODES</span> = <span style="color: #4f97d7;">[</span><span style="color: #a45bad;">500</span>, <span style="color: #a45bad;">503</span>, <span style="color: #a45bad;">504</span>, <span style="color: #a45bad;">400</span>, <span style="color: #a45bad;">403</span>, <span style="color: #a45bad;">404</span>, <span style="color: #a45bad;">408</span><span style="color: #4f97d7;">]</span>
<span style="color: #7590db;">DOWNLOADER_MIDDLEWARES</span> = <span style="color: #4f97d7;">{</span>
<span style="background-color: #555;"> </span>   <span style="color: #2d9574;">'scrapy.contrib.downloadermiddleware.useragent.UserAgentMiddleware'</span> : <span style="color: #a45bad;">None</span>,
<span style="background-color: #555;"> </span>   <span style="color: #2d9574;">'scrapy.contrib.downloadermiddleware.retry.RetryMiddleware'</span>: <span style="color: #a45bad;">90</span>,
<span style="background-color: #555;"> </span>   <span style="color: #2d9574;">'domain_parse.spiders.random_proxy.RandomProxy'</span>: <span style="color: #a45bad;">100</span>,
<span style="background-color: #555;"> </span>   <span style="color: #2d9574;">'scrapy.contrib.downloadermiddleware.httpproxy.HttpProxyMiddleware'</span>: <span style="color: #a45bad;">110</span>,
<span style="background-color: #555;"> </span>   <span style="color: #2d9574;">'domain_parse.spiders.user_agent_pool.UserAgentPoolMiddleware'</span>: <span style="color: #a45bad;">500</span>,
<span style="color: #4f97d7;">}</span>
<span style="color: #7590db;">PROXY_DB</span> = <span style="color: #2d9574;">'proxy.db'</span>
<span style="color: #7590db;">DOMAIN_LIST</span> = <span style="color: #2d9574;">'domain_list'</span>
<span style="color: #7590db;">CONCURRENT_REQUESTS</span> = <span style="color: #a45bad;">100</span>
<span style="color: #7590db;">REACTOR_THREADPOOL_MAXSIZE</span> = <span style="color: #a45bad;">20</span>
<span style="color: #7590db;">COOKIES_ENABLED</span>=<span style="color: #a45bad;">False</span>
<span style="color: #7590db;">REDIRECT_ENABLED</span> = <span style="color: #a45bad;">False</span>
<span style="color: #7590db;">AJAXCRAWL_ENABLED</span> = <span style="color: #a45bad;">True</span>
<span style="color: #7590db;">DOWNLOAD_HANDLERS</span>=<span style="color: #4f97d7;">{</span><span style="color: #2d9574;">'s3'</span>:<span style="color: #a45bad;">None</span>,<span style="color: #4f97d7;">}</span>
</pre>
</div>

</section>
<section id="slide-orgheadline32">
<h3 id="orgheadline32">pyspider</h3>
<ul>
<li>Write script in Python</li>
<li>Powerful WebUI with script editor, task monitor, project manager and result viewer</li>
<li>MySQL, MongoDB, Redis, SQLite, Elasticsearch; PostgreSQL with SQLAlchemy as database backend</li>
<li>RabbitMQ, Beanstalk, Redis and Kombu as message queue</li>
<li>Task priority, retry, periodical, recrawl by age, etc&#x2026;</li>
<li>Distributed architecture, Crawl Javascript pages, Python 2&amp;3, etc&#x2026;</li>

</ul>
<p>
<a href="https://github.com/binux/pyspider">https://github.com/binux/pyspider</a>
</p>


</section>
</section>
<section>
<section id="slide-orgheadline34">
<h2 id="orgheadline34">Q &amp; A</h2>
</section>
</section>
</div>
</div>
<script src="http://cdn.jsdelivr.net/reveal.js/3.0.0/lib/js/head.min.js"></script>
<script src="http://cdn.jsdelivr.net/reveal.js/3.0.0/js/reveal.js"></script>

<script>
// Full list of configuration options available here:
// https://github.com/hakimel/reveal.js#configuration
Reveal.initialize({

controls: true,
progress: true,
history: false,
center: true,
slideNumber: 'c',
rollingLinks: false,
keyboard: true,
overview: true,

theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
transition: Reveal.getQueryHash().transition || 'linear', // default/cube/page/concave/zoom/linear/fade/none
transitionSpeed: 'default',
multiplex: {
    secret: '', // null if client
    id: '', // id, obtained from socket.io server
    url: '' // Location of socket.io server
},

// Optional libraries used to extend on reveal.js
dependencies: [
 { src: 'http://cdn.jsdelivr.net/reveal.js/3.0.0/lib/js/classList.js', condition: function() { return !document.body.classList; } },
 { src: 'http://cdn.jsdelivr.net/reveal.js/3.0.0/plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
 { src: 'http://cdn.jsdelivr.net/reveal.js/3.0.0/plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
 { src: 'http://cdn.jsdelivr.net/reveal.js/3.0.0/plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
 { src: 'http://cdn.jsdelivr.net/reveal.js/3.0.0/plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }]
});
</script>
</body>
</html>
