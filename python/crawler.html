<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Python web crawler</title>
<meta name="author" content="(jiancheng.zhai)"/>
<style type="text/css">
.underline { text-decoration: underline; }
</style>
<link rel="stylesheet" href="http://cdn.jsdelivr.net/reveal.js/3.0.0/css/reveal.css"/>

<link rel="stylesheet" href="http://cdn.jsdelivr.net/reveal.js/3.0.0/css/theme/night.css" id="theme"/>


<!-- If the query includes 'print-pdf', include the PDF print sheet -->
<script>
    if( window.location.search.match( /print-pdf/gi ) ) {
        var link = document.createElement( 'link' );
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = 'http://cdn.jsdelivr.net/reveal.js/3.0.0/css/print/pdf.css';
        document.getElementsByTagName( 'head' )[0].appendChild( link );
    }
</script>
</head>
<body>
<div class="reveal">
<div class="slides">
<section id="sec-title-slide"><h1 class="title">Python web crawler</h1><h2 class="author">jiancheng.zhai</h2><p class="date">Created: 2016-11-30 Wed 14:24</p>
</section>

<section>
<section id="slide-org658c85a">
<h2 id="org658c85a">工作原理</h2>

</section>
</section>
<section>
<section id="slide-org6584727">
<h2 id="org6584727">Http 请求</h2>
<div class="outline-text-2" id="text-org6584727">
</div></section>
<section id="slide-orgb974e40">
<h3 id="orgb974e40">urllib</h3>
<div class="org-src-container">

<pre  class="src src-python">&gt;&gt;&gt; <span style="color: #7590db;">values</span> = <span style="color: #4f97d7;">{}</span>
&gt;&gt;&gt; <span style="color: #7590db;">values</span><span style="color: #4f97d7;">[</span><span style="color: #2d9574;">'username'</span><span style="color: #4f97d7;">]</span> = <span style="color: #2d9574;">"1016903103@qq.com"</span>
&gt;&gt;&gt; <span style="color: #7590db;">values</span><span style="color: #4f97d7;">[</span><span style="color: #2d9574;">'password'</span><span style="color: #4f97d7;">]</span> = <span style="color: #2d9574;">"</span><span style="color: #cc9393;">XXXX</span><span style="color: #2d9574;">"</span>
&gt;&gt;&gt; <span style="color: #7590db;">headers</span> = <span style="color: #4f97d7;">{</span><span style="color: #2d9574;">'User-Agent'</span>:<span style="color: #2d9574;">'Mozilla/6.0 (Windows; U; Windows NT 6.1; en-US; rv:1.9.1.6) Gecko/20091201 Firefox/3.5.6'</span> <span style="color: #4f97d7;">}</span>
&gt;&gt;&gt; <span style="color: #7590db;">data</span> = urllib.urlencode<span style="color: #4f97d7;">(</span>values<span style="color: #4f97d7;">)</span> 
&gt;&gt;&gt; <span style="color: #7590db;">request</span> = urllib2.Request<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"http://www.baidu.com"</span>, data, headers=headers<span style="color: #4f97d7;">)</span>
&gt;&gt;&gt; <span style="color: #7590db;">response</span> = urllib2.urlopen<span style="color: #4f97d7;">(</span>request<span style="color: #4f97d7;">)</span>
&gt;&gt;&gt; <span style="color: #4f97d7; font-weight: bold;">print</span> response.read<span style="color: #4f97d7;">()</span>
</pre>
</div>

</section>
<section id="slide-org46064b9">
<h3 id="org46064b9">requests: HTTP for Humans 发送请求</h3>
<div class="org-src-container">

<pre  class="src src-python"><span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#35774;&#32622;&#32534;&#30721;</span>
&gt;&gt;&gt; r.encoding
<span style="color: #2d9574;">'utf-8'</span>
&gt;&gt;&gt; <span style="color: #7590db;">r.encoding</span> = <span style="color: #2d9574;">'ISO-8859-1'</span>

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#23450;&#21046; headers</span>
&gt;&gt;&gt; <span style="color: #7590db;">url</span> = <span style="color: #2d9574;">'https://api.github.com/some/endpoint'</span>
&gt;&gt;&gt; <span style="color: #7590db;">headers</span> = <span style="color: #4f97d7;">{</span><span style="color: #2d9574;">'user-agent'</span>: <span style="color: #2d9574;">'my-app/0.0.1'</span><span style="color: #4f97d7;">}</span>
&gt;&gt;&gt; <span style="color: #7590db;">r</span> = requests.get<span style="color: #4f97d7;">(</span>url, headers=headers<span style="color: #4f97d7;">)</span>

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#21457;&#36865;&#35831;&#27714;</span>
&gt;&gt;&gt; <span style="color: #7590db;">r</span> = requests.put<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"http://httpbin.org/put"</span><span style="color: #4f97d7;">)</span>
&gt;&gt;&gt; <span style="color: #7590db;">r</span> = requests.delete<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"http://httpbin.org/delete"</span><span style="color: #4f97d7;">)</span>
&gt;&gt;&gt; <span style="color: #7590db;">r</span> = requests.head<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"http://httpbin.org/get"</span><span style="color: #4f97d7;">)</span>
&gt;&gt;&gt; <span style="color: #7590db;">r</span> = requests.options<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"http://httpbin.org/get"</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

</section>
<section id="slide-orgd4bbea6">
<h3 id="orgd4bbea6">requests: HTTP for Humans 传递参数</h3>
<div class="org-src-container">

<pre  class="src src-python">&gt;&gt;&gt; <span style="color: #7590db;">payload</span> = <span style="color: #4f97d7;">{</span><span style="color: #2d9574;">'key1'</span>: <span style="color: #2d9574;">'value1'</span>, <span style="color: #2d9574;">'key2'</span>: <span style="color: #2d9574;">'value2'</span><span style="color: #4f97d7;">}</span>
&gt;&gt;&gt; <span style="color: #7590db;">r</span> = requests.get<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"http://httpbin.org/get"</span>, params=payload<span style="color: #4f97d7;">)</span>
&gt;&gt;&gt; <span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>r.url<span style="color: #4f97d7;">)</span>
http://httpbin.org/get?<span style="color: #7590db;">key2</span>=value2&amp;<span style="color: #7590db;">key1</span>=value1
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#35835;&#21462;&#21709;&#24212;&#20869;&#23481;</span>
&gt;&gt;&gt; <span style="color: #7590db;">r</span> = requests.get<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'https://github.com/timeline.json'</span><span style="color: #4f97d7;">)</span>
&gt;&gt;&gt; r.text
u<span style="color: #2d9574;">'[{"repository":{"open_issues":0,"url":"https://github.com/...</span>
</pre>
</div>



</section>
</section>
<section>
<section id="slide-orgad4f349">
<h2 id="orgad4f349">页面解析</h2>
<div class="outline-text-2" id="text-orgad4f349">
</div></section>
<section id="slide-org6297342">
<h3 id="org6297342">html - beautifulsoup</h3>
<div class="org-src-container">

<pre  class="src src-python"><span style="color: #7590db;">html</span> = urllib2.urlopen<span style="color: #4f97d7;">(</span>req, timeout=<span style="color: #a45bad;">20</span><span style="color: #4f97d7;">)</span>.read<span style="color: #4f97d7;">()</span>
<span style="color: #7590db;">content</span> = BeautifulSoup<span style="color: #4f97d7;">(</span>html, <span style="color: #2d9574;">"lxml"</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">title</span> = content.title.get_text<span style="color: #4f97d7;">()</span>
</pre>
</div>
</section>
<section id="slide-org65175ff">
<h3 id="org65175ff">html - pyquery</h3>
<div class="org-src-container">

<pre  class="src src-python"><span style="color: #4f97d7; font-weight: bold;">from</span> pyquery <span style="color: #4f97d7; font-weight: bold;">import</span> PyQuery <span style="color: #4f97d7; font-weight: bold;">as</span> pq
<span style="color: #7590db;">content</span> = requests.get<span style="color: #4f97d7;">(</span>url, headers=headers<span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">doc</span> = pq<span style="color: #4f97d7;">(</span>ret.text<span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">en_mean_list</span> = doc<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'div.trans-container'</span><span style="color: #4f97d7;">)(</span><span style="color: #2d9574;">'ul'</span><span style="color: #4f97d7;">)(</span><span style="color: #2d9574;">'p.wordGroup'</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<div class="figure">
<p><img src="a.png" alt="a.png" />
</p>
</div>

</section>
<section id="slide-org4bf5358">
<h3 id="org4bf5358">js - selenium</h3>
<div class="org-src-container">

<pre  class="src src-python"><span style="color: #4f97d7; font-weight: bold;">from</span> selenium <span style="color: #4f97d7; font-weight: bold;">import</span> webdriver
<span style="color: #4f97d7; font-weight: bold;">from</span> selenium.common.exceptions <span style="color: #4f97d7; font-weight: bold;">import</span> NoSuchElementException
<span style="color: #4f97d7; font-weight: bold;">from</span> selenium.webdriver.common.keys <span style="color: #4f97d7; font-weight: bold;">import</span> Keys
<span style="color: #7590db;">base_url</span> = <span style="color: #2d9574;">'http://www.baidu.com/'</span>
<span style="color: #7590db;">browser</span> = webdriver.Chrome<span style="color: #4f97d7;">()</span>
browser.get<span style="color: #4f97d7;">(</span>base_url<span style="color: #4f97d7;">)</span>

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#35835;&#21462;&#21709;&#24212;&#20869;&#23481;, &#36825;&#37324;&#20351;&#29992; pyquery &#36827;&#34892;&#35299;&#26512;</span>
<span style="color: #7590db;">doc</span> = pq<span style="color: #4f97d7;">(</span>browser.page_source<span style="color: #4f97d7;">)</span>
doc.xhtml_to_html<span style="color: #4f97d7;">()</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#28857;&#20987;&#20803;&#32032;</span>
browser.find_element_by_css_selector<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'.pagination .next'</span><span style="color: #4f97d7;">)</span>.click<span style="color: #4f97d7;">()</span>
</pre>
</div>

</section>
<section id="slide-org452e971">
<h3 id="org452e971">js - PhantomJS</h3>
<ul>
<li>HEADLESS WEBSITE TESTING</li>
<li>SCREEN CAPTURE</li>
<li>PAGE AUTOMATION</li>
<li>NETWORK MONITORING</li>
<li><a href="http://phantomjs.org/">http://phantomjs.org/</a></li>

</ul>


</section>
</section>
<section>
<section id="slide-org87ed5de">
<h2 id="org87ed5de">大规模</h2>
<div class="outline-text-2" id="text-org87ed5de">
</div></section>
<section id="slide-orgddb8c34">
<h3 id="orgddb8c34">防屏蔽 - 代理池</h3>
<div class="org-src-container">

<pre  class="src src-python"><span style="color: #7590db;">page_num</span> = <span style="color: #a45bad;">10</span>
<span style="color: #7590db;">url_prefix</span> = <span style="color: #2d9574;">"http://www.xicidaili.com/wn/{pn}"</span>
<span style="color: #7590db;">url_list</span> = <span style="color: #4f97d7;">[</span>url_prefix.<span style="color: #4f97d7;">format</span><span style="color: #bc6ec5;">(</span>pn=x<span style="color: #bc6ec5;">)</span> <span style="color: #4f97d7; font-weight: bold;">for</span> x <span style="color: #4f97d7; font-weight: bold;">in</span> <span style="color: #4f97d7;">range</span><span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">1</span>, page_num<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">]</span>
<span style="color: #7590db;">headers</span> = <span style="color: #4f97d7;">{</span><span style="color: #2d9574;">'User-Agent'</span>:<span style="color: #2d9574;">'Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/33.0.1750.154 Safari/537.36'</span><span style="color: #4f97d7;">}</span>
<span style="color: #7590db;">headers</span><span style="color: #4f97d7;">[</span><span style="color: #2d9574;">'Content-Type'</span><span style="color: #4f97d7;">]</span> = <span style="color: #2d9574;">'application/x-www-form-urlencoded'</span>
<span style="color: #7590db;">requests</span> = requests.get<span style="color: #4f97d7;">(</span>url, headers=headers<span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">soup</span> = BeautifulSoup<span style="color: #4f97d7;">(</span>requests.text<span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">tables</span> = soup.findAll<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'table'</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">trs</span> = table.findAll<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'tr'</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">res_list</span> = <span style="color: #4f97d7;">[]</span>
<span style="color: #4f97d7; font-weight: bold;">for</span> index, tr <span style="color: #4f97d7; font-weight: bold;">in</span> <span style="color: #4f97d7;">enumerate</span><span style="color: #4f97d7;">(</span>trs<span style="color: #4f97d7;">)</span>:
<span style="background-color: #555;"> </span>   res_list.append<span style="color: #4f97d7;">(</span>item.text.encode<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">'utf8'</span><span style="color: #bc6ec5;">)</span>.strip<span style="color: #bc6ec5;">()</span><span style="color: #4f97d7;">)</span>

<span style="color: #7590db;">ip</span>, <span style="color: #7590db;">port</span>, <span style="color: #7590db;">country</span>, <span style="color: #7590db;">proxy_type</span>, <span style="color: #7590db;">protocol</span> = res_list<span style="color: #4f97d7;">[</span><span style="color: #a45bad;">1</span>:<span style="color: #a45bad;">6</span><span style="color: #4f97d7;">]</span>
</pre>
</div>

</section>
<section id="slide-orgf917333">
<h3 id="orgf917333">防屏蔽 - 换 user agent</h3>
<div class="org-src-container">

<pre  class="src src-python"><span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#38543;&#26426;&#25442; user agent</span>
<span style="color: #4f97d7; font-weight: bold;">from</span> fake_useragent <span style="color: #4f97d7; font-weight: bold;">import</span> UserAgent
<span style="color: #7590db;">ua</span> = UserAgent<span style="color: #4f97d7;">()</span>
<span style="color: #7590db;">headers</span> = <span style="color: #4f97d7;">{</span><span style="color: #2d9574;">'User-Agent'</span>: ua.random<span style="color: #4f97d7;">}</span>
</pre>
</div>
</section>
<section id="slide-org2d3e9ad">
<h3 id="org2d3e9ad">防屏蔽 - 合理的抓取频率</h3>
</section>
<section id="slide-orgef05b41">
<h3 id="orgef05b41">cookie 处理</h3>
<div class="org-src-container">

<pre  class="src src-python"><span style="color: #4f97d7; font-weight: bold;">import</span> browsercookie
<span style="color: #7590db;">cj</span> = browsercookie.chrome<span style="color: #4f97d7;">()</span>
<span style="color: #7590db;">opener</span> = urllib2.build_opener<span style="color: #4f97d7;">(</span>urllib2.HTTPCookieProcessor<span style="color: #bc6ec5;">(</span>cj<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">response</span> = opener.<span style="color: #4f97d7;">open</span><span style="color: #4f97d7;">(</span>url<span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">resource_data</span> = response.read<span style="color: #4f97d7;">()</span>
</pre>
</div>
</section>
<section id="slide-org7d93e59">
<h3 id="org7d93e59">重复性验证 bloom filter</h3>
<div class="org-src-container">

<pre  class="src src-python"><span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#22823;&#26679;&#26412;&#19979; Hash &#31354;&#38388;/&#26102;&#38388;&#28040;&#32791;&#22343;&#19981;&#29702;&#24819;</span>
<span style="color: #4f97d7; font-weight: bold;">from</span> pybloom <span style="color: #4f97d7; font-weight: bold;">import</span> BloomFilter, ScalableBloomFilter
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#35823;&#25253;&#29575; 0.1%</span>
<span style="color: #7590db;">bf</span> = BloomFilter<span style="color: #4f97d7;">(</span>capacity=<span style="color: #a45bad;">10000</span>, error_rate=<span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">001</span><span style="color: #4f97d7;">)</span>
bf.add<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'test'</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">print</span> <span style="color: #2d9574;">'test'</span> <span style="color: #4f97d7; font-weight: bold;">in</span> bf
<span style="color: #7590db;">sbf</span> = ScalableBloomFilter<span style="color: #4f97d7;">(</span>mode=ScalableBloomFilter.SMALL_SET_GROWTH<span style="color: #4f97d7;">)</span>
sbf.add<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'dddd'</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">print</span> <span style="color: #2d9574;">'ddd'</span> <span style="color: #4f97d7; font-weight: bold;">in</span> sbf
</pre>
</div>
</section>
<section id="slide-orgd56aa88">
<h3 id="orgd56aa88">并发 - 多进程</h3>
<div class="org-src-container">

<pre  class="src src-python"><span style="color: #4f97d7; font-weight: bold;">from</span> multiprocessing <span style="color: #4f97d7; font-weight: bold;">import</span> Process, Event
<span style="color: #4f97d7; font-weight: bold;">from</span> multiprocessing <span style="color: #4f97d7; font-weight: bold;">import</span> Manager
<span style="color: #4f97d7; font-weight: bold;">from</span> multiprocessing <span style="color: #4f97d7; font-weight: bold;">import</span> Queue, JoinableQueue
<span style="color: #7590db;">POISON_PILL</span> = <span style="color: #2d9574;">"POISON_END_PROCESSING"</span>
<span style="color: #7590db;">manager</span> = Manager<span style="color: #4f97d7;">()</span>
<span style="color: #7590db;">worker</span> = Queue<span style="color: #4f97d7;">()</span>
<span style="color: #7590db;">WORKER_NUM</span> = <span style="color: #a45bad;">20</span>

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#21551;&#21160;&#20889;&#32447;&#31243;</span>
<span style="color: #7590db;">writer_proc</span> = Process<span style="color: #4f97d7;">(</span>target=write_to_disk, args=<span style="color: #bc6ec5;">()</span><span style="color: #4f97d7;">)</span>
writer_proc.start<span style="color: #4f97d7;">()</span>

<span style="color: #7590db;">pool</span> = Pool<span style="color: #4f97d7;">(</span>WORKER_NUM, crawl_url, <span style="color: #bc6ec5;">(</span>queue, result_queue<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
pool.close<span style="color: #4f97d7;">()</span>
pool.join<span style="color: #4f97d7;">()</span>
</pre>
</div>

</section>
<section id="slide-org7002aa7">
<h3 id="org7002aa7">并发 - 协程</h3>
<div class="org-src-container">

<pre  class="src src-python"><span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">crawl_url</span><span style="color: #4f97d7;">()</span>:
<span style="background-color: #555;"> </span>   <span style="color: #7590db;">send_headers</span> = <span style="color: #4f97d7;">{</span><span style="color: #2d9574;">'User-Agent'</span>: <span style="color: #2d9574;">'Mozilla/6.0 (Windows; U; Windows NT 6.1; en-US; rv:1.9.1.6) Gecko/20091201 Firefox/3.5.6'</span><span style="color: #4f97d7;">}</span>
<span style="background-color: #555;"> </span>   <span style="color: #7590db;">crawl_res</span> = <span style="color: #4f97d7;">{}</span>
<span style="background-color: #555;"> </span>   <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #a45bad;">True</span>:
<span style="background-color: #555;"> </span>   <span style="background-color: #555;"> </span>   <span style="color: #7590db;">url</span> = <span style="color: #4f97d7; font-weight: bold;">yield</span> crawl_res
<span style="background-color: #555;"> </span>   <span style="background-color: #555;"> </span>   <span style="color: #7590db;">request</span> = urllib2.Request<span style="color: #4f97d7;">(</span>url, headers=headers<span style="color: #4f97d7;">)</span>
<span style="background-color: #555;"> </span>   <span style="background-color: #555;"> </span>   <span style="color: #7590db;">html</span> = urllib2.urlopen<span style="color: #4f97d7;">(</span>req, timeout=<span style="color: #a45bad;">10</span><span style="color: #4f97d7;">)</span>.read<span style="color: #4f97d7;">()</span>
<span style="background-color: #555;"> </span>   <span style="background-color: #555;"> </span>   <span style="color: #7590db;">content</span> = BeautifulSoup<span style="color: #4f97d7;">(</span>html, <span style="color: #2d9574;">"lxml"</span><span style="color: #4f97d7;">)</span>
<span style="background-color: #555;"> </span>   <span style="background-color: #555;"> </span>   <span style="color: #7590db;">title</span> = content.title.get_text<span style="color: #4f97d7;">()</span>
<span style="background-color: #555;"> </span>   <span style="background-color: #555;"> </span>   <span style="color: #7590db;">crawl_res</span><span style="color: #4f97d7;">[</span>url<span style="color: #4f97d7;">]</span> = title


<span style="color: #7590db;">crawler</span> = crawl_url
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#35201;&#20808;&#25191;&#34892;&#19968;&#27425; next &#26041;&#27861;</span>
<span style="color: #7590db;">crawl_res</span> = crawler.<span style="color: #4f97d7;">next</span><span style="color: #4f97d7;">()</span>

<span style="color: #7590db;">result_list</span> = <span style="color: #4f97d7;">[]</span>
<span style="color: #4f97d7; font-weight: bold;">for</span> url <span style="color: #4f97d7; font-weight: bold;">in</span> url_list:
<span style="background-color: #555;"> </span>   <span style="color: #7590db;">crawl_res</span> = crawler.send<span style="color: #4f97d7;">(</span>url<span style="color: #4f97d7;">)</span>
<span style="background-color: #555;"> </span>   result_list.append<span style="color: #4f97d7;">(</span>crawl_res<span style="color: #4f97d7;">)</span>
</pre>
</div>

</section>
<section id="slide-org646e040">
<h3 id="org646e040">并发 - 多进程 + 协程</h3>
<div class="org-src-container">

<pre  class="src src-python"><span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">multiprocessing &#30340; pool &#21644; gevent &#20914;&#31361;</span>
<span style="color: #4f97d7; font-weight: bold;">from</span> multiprocessing <span style="color: #4f97d7; font-weight: bold;">import</span> Process
<span style="color: #4f97d7; font-weight: bold;">import</span> gevent
<span style="color: #4f97d7; font-weight: bold;">from</span> gevent <span style="color: #4f97d7; font-weight: bold;">import</span> monkey; monkey.patch_all<span style="color: #4f97d7;">()</span>

<span style="color: #2aa1ae; background-color: #292e34;">#</span><span style="color: #2aa1ae; background-color: #292e34;">&#20351;&#29992;&#21327;&#31243;&#26469;&#25191;&#34892;</span>
<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">process_start</span><span style="color: #4f97d7;">(</span>tasks<span style="color: #4f97d7;">)</span>:
<span style="background-color: #555;"> </span>   gevent.joinall<span style="color: #4f97d7;">(</span>tasks<span style="color: #4f97d7;">)</span>


<span style="color: #4f97d7; font-weight: bold;">with</span> <span style="color: #4f97d7;">open</span><span style="color: #4f97d7;">(</span>crawl_url_file<span style="color: #4f97d7;">)</span> <span style="color: #4f97d7; font-weight: bold;">as</span> url_reader:
<span style="background-color: #555;"> </span>   <span style="color: #7590db;">url</span> = url_reader.readline.strip<span style="color: #4f97d7;">()</span>
<span style="background-color: #555;"> </span>   <span style="color: #7590db;">task_list</span> = <span style="color: #4f97d7;">[]</span>
<span style="background-color: #555;"> </span>   <span style="color: #7590db;">i</span> = <span style="color: #a45bad;">0</span>
<span style="background-color: #555;"> </span>   <span style="color: #4f97d7; font-weight: bold;">while</span> url:
<span style="background-color: #555;"> </span>   <span style="background-color: #555;"> </span>   <span style="color: #7590db;">i</span> += <span style="color: #a45bad;">1</span>
<span style="background-color: #555;"> </span>   <span style="background-color: #555;"> </span>   task_list.append<span style="color: #4f97d7;">(</span>gevent.spawn<span style="color: #bc6ec5;">(</span>crawl_method, url, <span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

<span style="background-color: #555;"> </span>   <span style="background-color: #555;"> </span>   <span style="color: #4f97d7; font-weight: bold;">if</span> i &gt;= MAX_TASK_NUM:
<span style="background-color: #555;"> </span>   <span style="background-color: #555;"> </span>   <span style="background-color: #555;"> </span>   <span style="color: #7590db;">p</span> = Process<span style="color: #4f97d7;">(</span>target = process_start, args=<span style="color: #bc6ec5;">(</span>task_list, <span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="background-color: #555;"> </span>   <span style="background-color: #555;"> </span>   <span style="background-color: #555;"> </span>   p.start<span style="color: #4f97d7;">()</span>
<span style="background-color: #555;"> </span>   <span style="background-color: #555;"> </span>   <span style="background-color: #555;"> </span>   <span style="color: #7590db;">task_list</span> = <span style="color: #4f97d7;">[]</span>
<span style="background-color: #555;"> </span>   <span style="background-color: #555;"> </span>   <span style="background-color: #555;"> </span>   <span style="color: #7590db;">i</span> = <span style="color: #a45bad;">0</span>
<span style="background-color: #555;"> </span>   <span style="background-color: #555;"> </span>   <span style="color: #7590db;">url</span> = url_reader.readline.strip<span style="color: #4f97d7;">()</span>

<span style="background-color: #555;"> </span>   <span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#25235;&#21462;&#21097;&#20313; url</span>
<span style="background-color: #555;"> </span>   <span style="color: #4f97d7; font-weight: bold;">if</span> task_list:
<span style="background-color: #555;"> </span>   <span style="background-color: #555;"> </span>   <span style="color: #7590db;">p</span> = Process<span style="color: #4f97d7;">(</span>target=process_start, args=<span style="color: #bc6ec5;">(</span>task_list, <span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="background-color: #555;"> </span>   <span style="background-color: #555;"> </span>   p.start<span style="color: #4f97d7;">()</span>
</pre>
</div>


</section>
<section id="slide-org3b7ae70">
<h3 id="org3b7ae70">并发 - 分布式</h3>
<div class="org-src-container">

<pre  class="src src-python"><span style="color: #4f97d7; font-weight: bold;">import</span> redis
<span style="color: #7590db;">redis_conn</span> = redis.StrictRedis<span style="color: #4f97d7;">()</span>
<span style="color: #7590db;">FETCH_QUEUE</span> = <span style="color: #2d9574;">'FETCH'</span>
<span style="color: #4f97d7; font-weight: bold;">for</span> item <span style="color: #4f97d7; font-weight: bold;">in</span> item_list:
<span style="background-color: #555;"> </span>   redis_conn.rpush<span style="color: #4f97d7;">(</span>FETCH_QUEUE, item<span style="color: #4f97d7;">)</span>
</pre>
</div>


</section>
</section>
<section>
<section id="slide-org0cf4630">
<h2 id="org0cf4630">数据存储</h2>
<div class="outline-text-2" id="text-org0cf4630">
</div></section>
<section id="slide-orgb0b379a">
<h3 id="orgb0b379a">sqllite</h3>
</section>
<section id="slide-org52b9ccc">
<h3 id="org52b9ccc">mongodb</h3>
</section>
<section id="slide-org947f6d2">
<h3 id="org947f6d2">postgreSQL</h3>


</section>
</section>
<section>
<section id="slide-orgc08e5f8">
<h2 id="orgc08e5f8">框架</h2>
<div class="outline-text-2" id="text-orgc08e5f8">
</div></section>
<section id="slide-orgad65854">
<h3 id="orgad65854">scrapy</h3>
</section>
<section id="slide-orge492183">
<h3 id="orge492183">pyspider</h3>


</section>
</section>
<section>
<section id="slide-org8b095b0">
<h2 id="org8b095b0">Q &amp; A</h2>
</section>
</section>
</div>
</div>
<script src="http://cdn.jsdelivr.net/reveal.js/3.0.0/lib/js/head.min.js"></script>
<script src="http://cdn.jsdelivr.net/reveal.js/3.0.0/js/reveal.js"></script>

<script>
// Full list of configuration options available here:
// https://github.com/hakimel/reveal.js#configuration
Reveal.initialize({

controls: true,
progress: true,
history: false,
center: true,
slideNumber: 'c',
rollingLinks: false,
keyboard: true,
overview: true,

theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
transition: Reveal.getQueryHash().transition || 'linear', // default/cube/page/concave/zoom/linear/fade/none
transitionSpeed: 'default',
multiplex: {
    secret: '', // null if client
    id: '', // id, obtained from socket.io server
    url: '' // Location of socket.io server
},

// Optional libraries used to extend on reveal.js
dependencies: [
 { src: 'http://cdn.jsdelivr.net/reveal.js/3.0.0/lib/js/classList.js', condition: function() { return !document.body.classList; } },
 { src: 'http://cdn.jsdelivr.net/reveal.js/3.0.0/plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
 { src: 'http://cdn.jsdelivr.net/reveal.js/3.0.0/plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
 { src: 'http://cdn.jsdelivr.net/reveal.js/3.0.0/plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
 { src: 'http://cdn.jsdelivr.net/reveal.js/3.0.0/plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }]
});
</script>
</body>
</html>
